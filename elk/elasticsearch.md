# Elasticsearch基础

elasticsearch 是一个`分布式`的数据`搜索引擎`，是elk三大框架的核心，其主打的功能是支持`几乎实时性的聚合搜索`，其性能很高，类比 `Hadoop` 可能一天才会算出来的结果它瞬间就可以返回，并且作为一个分布式集群，其也具有高可用性和可扩展性的能力。其底层是Java的类库 `Lucene`。

## 概念

elasticsearch内部包含很多以前从来没有接触过的概念，也是因为这些概念成为学习elasticsearch的入门的门槛。因此在此大概列举一下我自己理解中的各个概念的意义，方便后续查询和使用。

#### 一、数据结构方面

elasticsearch定义了很多概念去描述收集到的数据，具体如下：

1. 索引(Index)：索引不同于普通数据库的概念，es中的索引可以类比于`数据库中的表`，是特定数据的一个集合体
2. 文档(Document)：文档可以简单看作是数据库`表中的数据`
3. Mapping：是对一个索引中字段的描述，可以类比于数据库中的数据库`表的Scheme`
4. Setting：是对索引的配置，类比于数据库`表的约束`，可以记录当前索引的一些独占或者共享的配置信息，比如分片配置等
5. Index Template：是对索引的Setting模板，elasticsearch在默认是都会给所有索引提供一个模板，用户也可以自定义自己的Setting模板，可以通过通配符批量改变索引的配置

elasticsearch通过上述数据去定义和划分每一类数据，作为刚入门的学习者，我把上述的这些定义都一一类比成了数据库中的定义，方面理解。

#### 二、系统结构方面

elasticsearch是一个独立的服务，因为其是支持分布式的，因此会有分布式中集群的概念。es通过下述的这些概念来定义集群中不同的服务。

1. 节点(Node)：节点可以理解为一个elasticsearch的一个实例，从属于集群中。旗下分为几个类型，比较有代表性的有：`master node`, `eligible node`, `data node` 以及 `coordinating node`
2. 分片(Shard)：分片是elasticsearch`存储索引的物理单元(Lucene实例)`，所有写入elasticsearch集群中的数据都存储在分片上。分片分为`主分片(Primary Shard)`和`副本分片(Replica Shard)`，可以简单理解为主备数据库
3. Health：每个elasticsearch集群都有Health的概念，分三个等级：`green`，`yellow`和`red`。其代表着集群中索引的存储状况。green表示索引数据很好地分布在配置的主备分片中；yellow表示只有主分片在工作，副本分片异常；red表示主分片异常

对上述的概念我第一次看的时候也是一头雾水。再此大概说明一下这三个概念：

节点是elasticsearch的实例这个很好理解，在服务器中运行的elasticsearch服务就是一个node，不好理解的是node的分类：

- master node：表示集群的主节点，只有主节点有权利改变集群的状态分配调度等
- eligible node：是实例刚运行起来的状态，每个node在刚运行起来都是eligible node，表示它有权利被选举为主节点
- data node：是指只用于存储数据的node，每个节点默认情况下都是data node
- coordinating node：协同节点，我自己理解为系统总线，是调度分发内部任务的节点，默认情况下所有节点也都是coordinating node

至于master的概念个人的理解是类似于`zookeeper`的选举制度，如果了解过`zookeeper`就知道一个集群在启动的时候会选举一个master，这个master有权力控制其他slaver。elasticsearch官方建议一台物理服务器中只运行一个node

而分片是我个人很难理解的一个概念，目前我能理解到的是：分片就是用来`存储索引`的Lucene实例，一个node上如果存了5个索引，那么它上面至少有这5个索引的分片。主分片的创建是在索引创建时创建的，索引中的Setting也会配置这个索引的分片信息，比如此索引需要几个主分片几个副本分片等。而副本分片就是为了保证数据持久化存在的对数据的备份，因此副本分片不会存在于主分片的node中。

只要理解了上述两个概念，Health的概念就很明显了，索引在创建时会指定分片的数量，默认是1主1副。如果当前集群中满足索引的配置，则集群状态为green；如果只有主没有副则为yellow；如果主都没有则为red。

至此，我们可以对elasticsearch的数据和数据库进行一下类比：elasticsearch中的数据存储在索引(表)中，而索引的具体存在data node(数据库服务器)中的分片(最终存储文件)中。

#### 三、操作方面

理解上述两部分之后，数据存储就解决了。之后就要开始对这些数据进行一系列操作了。elasticsearch对数据操作也进行了一系列定义，甚至`类比于传统数据库中的SQL`查询语言，`自己定义了一套DSL`搜索语言，其目的也就是对数据进行`CRUD操作`的。因此也就需要理解下述的一些概念了：

1. Analysis：即分词，是对存入elasticsearch中的数据进行一系列分析，最终存入索引中。其由三部分组成：`Character Filter`、`Tokenizer`和`Token Filter`
2. 倒排索引：倒排索引是搜索引擎常用的一种技术，这里的索引是真正意义上的索引，是指通过结果反向记录存储位置的索引，这也是elasticsearch搜索的核心概念
3. 算分：elasticsearch内有一套严格的算分机制，elasticsearch会通过对搜索结果进行打分，并且最终通过算分结果倒序返回查询结果。其算分也是通过严谨的统计学论文推导得出的

这三个概念比较难理解，我也只能用我自己的理解分别解释一下：

分词，即当数据进入elasticsearch时，会对进入的数据进行分词处理，其三个不同的组件分别的作用是：

- Character Filter：对原始的数据进行分词，比如删除HTML标记等操作
- Tokenizer：对第一步之后的结果进行token化，比如按照特定规则将语句拆分成单词
- Token Filter：对第二步的结果进行过滤，比如单词转小写、删除无实意的介词等

数据进入elasticsearch就是通过一系列的分词，最终存储在索引中的。

倒排索引，当理解了分词的作用，就知道倒排索引的作用了。首先看什么是正常索引，正常索引可以理解为书的目录，通过`标号——内容`进行映射。倒排索引就是将分词之后的一个一个单词进行索引，建立`单词——位置`的映射。其目的就是为了在之后进行搜索是可以很快通过搜索的内容进行索引查找原数据的地址。

算分，是elasticsearch对数据进行搜索结果的评分。这里的搜索和查询是不相同的，搜索的结果是模糊的，因此有可能结果不完全匹配，因此就需要算分的概念来对结果进行评分，默认情况下是通过算分结果由高到低返回的。而分的高低是根据结果匹配度来计算的，有内部严格的算法和论文概念。

## 操作

elasticsearch提供了完善的RESTful API，其具体操作也是对数据进行CRUD操作。并且也有一定的区别，接口的参数传递有两种方式`QueryString`和`Request Body`。

- `QueryString`：就是直接在Uri中拼接条件，但是可用的参数都比较单一，只能做单字段的搜索等操作
- `Request Body`：是通过Request Body中传递JSON格式的参数，在其中可以加入完整的DSL语法，可以更细化的操作数据


#### 一、Create

可以通过调用RESTful接口创建索引和文档